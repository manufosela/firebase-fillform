<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<dom-module id="firebase-fillform">
  <template>
    <style>
      :host {
        display: block;
      }
      .error_msg { font-weight:bold; color:blue; padding:15px; }
      .path { color:green;}
      paper-button {
        background: green;
        color: yellow;
        float: right
      }
      paper-button:hover {
        background: lime;
        color: green;
      }
      paper-button[disabled],
      paper-button[toggles][active] {
        background: red;
      }
    </style>
    <firebase-app
      api-key="AIzaSyBTrSst4ygTZmVyYUHLBEZbCxPfe4ULwKw"
      auth-domain="kustomerdigitalmanagment.firebaseapp.com"
      database-url="https://kustomerdigitalmanagment.firebaseio.com"
      project-id="kustomerdigitalmanagment"
      storage-bucket="kustomerdigitalmanagment.appspot.com"
      messaging-sender-id="948480016785">
    </firebase-app>
    <firebase-auth id="auth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>
    <firebase-document
      path="{{path}}"
      data="{{data}}">
    </firebase-document>
    <paper-button class="login" raised on-tap="login" hidden$="[[user]]">Sign in</paper-button>
    <paper-button class="login" raised on-tap="logout" hidden$="[[!user]]">Sign out</paper-button>
    <div class="formfieldlayer"></div>
  </template>

  <script>
    class FirebaseFillform extends Polymer.Element {
      static get is() { return 'firebase-fillform'; }
      static get properties() {
        return {
          path:{
            type: String
          },
          data: {
            type: Object,
            observer:'_dataChange'
          },
          user: Object
        };
      }

      _dataChange() {
        this._getFields(this.data[0]);
      }

      _getFields(obj) {
        if (obj===undefined && !this.root.querySelector('.error_msg')) {
          this._showError();
        } else {
          this._cleanError();
          for(var k in obj) {
            if (typeof obj[k]==='object') {
              if (Array.isArray(obj[k])) {
                //console.log('key: '+k + ' type: Array'); console.log(obj[k]);
                this._createCombo(k, obj[k]);
              } else {
                //console.log('key: '+k + ' type: ' + typeof obj[k]); console.log(obj[k]);
                this._getFields(obj[k]);
              }
            }

            if (typeof obj[k]==='string' || typeof obj[k]==='number') {
              this._createField(k);
            }
          }
          this._sendButton();
        }
      }

      _createField(k) {
        if (!this.root.querySelector('#'+k)) {
          var d = document.createElement('vaadin-text-field');
          d.label=k;
          d.id=k;
          this.root.appendChild(d);
        }
      }
      _createCombo(k, arr){
        if (!this.root.querySelector('#'+k)) {
          var d = document.createElement('vaadin-combo-box');
          d.label=k;
          d.id=k;
          window.addEventListener('WebComponentsReady', function() {
            d.items = arr;
          });
          this.root.appendChild(d);
        }
      }
      _sendButton(){
        if (!this.root.querySelector('#sendBtn')) {
          var d = document.createElement('paper-button');
          d.id='sendBtn';
          d.innerHTML='Save';
          d.raised;
          d.role='button';
          this.root.appendChild(d);
        }
      }
      _showError(){
        var d = document.createElement('div');
        d.className='error_msg';
        d.innerHTML = 'Path <span class="path">' + this.path + '</span> doesn\'t exists';
        this.root.appendChild(d);
      }
      _cleanError(){
        var errmsg = this.root.querySelector('.error_msg');
        if (errmsg) { errmsg.remove(); }
      }

      login() {
        return this.$.auth.signInWithPopup().then(this.signin.bind(this));
      }

      logout() {
        return this.$.auth.signOut().then(this.signout.bind(this));
      }

      signin() {
        //console.log('logged');
        //console.log(this.data, this.path);
      }

      signout(){
        //console.log('log out');
      }      

    }

    window.customElements.define(FirebaseFillform.is, FirebaseFillform);
  </script>
</dom-module>
