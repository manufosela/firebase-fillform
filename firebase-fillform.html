<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">

<dom-module id="firebase-fillform">
  <template>
    <style>
      :host {
        display: block;
      }
      .error_msg { font-weight:bold; color:blue; padding:15px; }
      .path { color:green;}
      #formfieldlayer { margin-bottom:30px; }
      .inlineblock { display:inline-block; }
      paper-button.login {
        background: green;
        color: yellow;
      }
      paper-button.login:hover {
        background: lime;
        color: green;
      }
      paper-button.save {
        background: yellow;
        color: blue;
      }
      paper-button.save:hover {
        background: cyan;
        color: yellow;
      }
      paper-button[disabled],
      paper-button[toggles][active] {
        background: red;
      }
      </style>
    <firebase-auth id="auth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>
    <firebase-document
      id="docfire"
      data="{{data}}">
    </firebase-document>
    <div id="formfieldlayer"></div>
    <paper-button class="login" raised on-tap="login" hidden$="[[user]]">Sign in</paper-button>
    <paper-button class="login" raised on-tap="logout" hidden$="[[!user]]">Sign out</paper-button>
    <paper-button class="save" raised on-tap="save" hidden$="[[datauser]]">Save</paper-button>
  </template>

  <script>
    class FirebaseFillform extends Polymer.Element {
      static get is() { return 'firebase-fillform'; }
      static get properties() {
        return {
          path:{
            type: String
          },
          data: {
            type: Object,
            observer:'_dataChange'
          },
          user: {
            type: Object,
            observer:'_userChange'
          },
          datauser: {
            type: Boolean,
            value: !!(this.user && this.data)
          },
          _counter: {
            type: Array,
            value: []
          },
          _arrKeys: {
            type: Array,
            value: []
          }
        };
      }

      _dataChange() {
        this._getFields(this.data[0]);
      }
      _userChange(){
        if (this.user && !this.$.docfire.path) {
          this.$.docfire.path = this.path;
        }
      }

      _getFields(obj) {
        this._cleanError();
        this._arrKeys = [];
        for(var k in obj) {
          this._arrKeys.push(k);
          if (typeof obj[k]==='object') {
              var f = this._createMF(k, typeof obj[k][0]);
              this.$.formfieldlayer.appendChild(f);
          } else if (typeof obj[k]==='string' || typeof obj[k]==='number') {
            var f = this._createField(k, typeof obj[k]);
            this.$.formfieldlayer.appendChild(f);
          }
        }
      }

      _createFormGroup(){
        var c = document.createElement('div');
        c.className='formGroup';
        return c;
      }

      _createField(labelId, typeobj) {
        var c = this._createFormGroup();
        if (!this.$['#'+labelId]) {
          c.innerHTML='<paper-input label="'+labelId+'" id="'+labelId+'"><div slot="prefix">['+typeobj+']&nbsp;&nbsp;</div></paper-input>';
        }
        return c;
      }
      _createMF(labelId, typeobj){
        var c = this._createFormGroup();
        this._createMultiField(c, labelId, typeobj);
        return c;
      }
      _createMultiField(container, labelId, typeobj){
        var c = this._createFormGroup();
        this._counter[labelId] = (!this._counter[labelId])?0:this._counter[labelId]++;
        let id = labelId + '_' + this._counter[labelId];
        c.innerHTML = '<paper-input always-float-label label="'+labelId+'" id="'+id+'" class="inlineblock"><div slot="prefix">['+typeobj+']&nbsp;&nbsp;</paper-input>';

        var e = document.createElement('button');
        e.id = labelId + '_btn';
        e.innerHTML='+';
        e.addEventListener('click', this._newMultiField.bind(this));
        c.appendChild(e);

        container.appendChild(c);
      }
      _newMultiField(ev){
        var labelId = ev.target.id.replace('_btn', '');
        var container = ev.target.parentNode.parentNode;
        this._counter[labelId]++;
        var c = this._createFormGroup();
        if (!this.$['#'+labelId]) {
          let id = labelId + '_' + this._counter[labelId];
          c.innerHTML = '<paper-input always-float-label label="'+labelId+'" id="'+id+'" class="inlineblock"></paper-input>';
        }
        container.appendChild(c);
      }
      _showError(msg){
        this.$.formfieldlayer.innerHTML = '';
        var arrMsg = {
          nopath: 'Path <span class="path">' + this.path + '</span> doesn\'t exists',
          none: ''
        }
        var d = (!this.root.querySelector('.error_msg'))?document.createElement('div'):this.root.querySelector('.error_msg');
        d.className='error_msg';
        d.innerHTML = arrMsg[msg];
        if (!this.root.querySelector('.error_msg')) {
          this.$.formfieldlayer.appendChild(d);
        }
      }
      _cleanError(){
        var errmsg = this.root.querySelector('.error_msg');
        if (errmsg) { errmsg.remove(); }
      }
      _dataSaved(){
        console.log('saved data in firebase');
      }

      login() {
        return this.$.auth.signInWithPopup().then(this.signin.bind(this));
      }

      logout() {
        return this.$.auth.signOut().then(this.signout.bind(this));
      }

      signin() {
        this.$.docfire.path = this.path;
        //console.log('logged');
        //console.log(this.data, this.path);
      }

      signout(){
        this.$.docfire.path = null;
        this._showError('none');
        //console.log('log out');
      }      

      save(){
        let data = {};
        for(let i=0; i<this._arrKeys.length; i++) {
          let el = this.root.querySelector('#'+this._arrKeys[i]);
          if (el) {
            let val = el.$.input.value;
            data[this._arrKeys[i]]=val;
            //console.log(this._arrKeys[i] + ' = ' + val);
          } else {
            let els = this.root.querySelectorAll('paper-input[id^=' + this._arrKeys[i] + '_]');
            //console.log(this._arrKeys[i]);
            data[this._arrKeys[i]]=[];
            for(let j=0; j<els.length; j++) {
              let el = els[j];
              let val = els[j].$.input.value;
              data[this._arrKeys[i]][j]=val;
              //console.log('\t' + j + ' = ' + val);
            }
          }
        }
        console.dir(data);
        //this.data[this.data.length] = data;        
        this.root.querySelector('#docfire').ref.push(data, this._dataSaved);
      }

    }

    window.customElements.define(FirebaseFillform.is, FirebaseFillform);
  </script>
</dom-module>
