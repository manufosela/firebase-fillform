<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/iron-form/iron-form.html">

<dom-module id="firebase-fillform">
  <template>
    <style>
      :host {
        display: block;
      }
      .error_msg { font-weight:bold; color:blue; padding:15px; }
      .path { color:green;}
      #formfieldlayer { margin-bottom:30px; }
      .inlineblock { display:inline-block; }
      paper-button.login {
        background: green;
        color: yellow;
      }
      paper-button.login:hover {
        background: lime;
        color: green;
      }
      paper-button.save {
        background: yellow;
        color: blue;
      }
      paper-button.save:hover {
        background: cyan;
        color: yellow;
      }
      paper-button[disabled],
      paper-button[toggles][active] {
        background: red;
      }
      </style>
    <firebase-app
      api-key="AIzaSyBTrSst4ygTZmVyYUHLBEZbCxPfe4ULwKw"
      auth-domain="kustomerdigitalmanagment.firebaseapp.com"
      database-url="https://kustomerdigitalmanagment.firebaseio.com"
      project-id="kustomerdigitalmanagment"
      storage-bucket="kustomerdigitalmanagment.appspot.com"
      messaging-sender-id="948480016785">
    </firebase-app>
    <firebase-auth id="auth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>
    <firebase-document
      id="docfire"
      data="{{data}}">
    </firebase-document>
    <div id="formfieldlayer"></div>
    <paper-button class="login" raised on-tap="login" hidden$="[[user]]">Sign in</paper-button>
    <paper-button class="login" raised on-tap="logout" hidden$="[[!user]]">Sign out</paper-button>
    <paper-button class="save" raised hidden$="[[datauser]]">Save</paper-button>
  </template>

  <script>
    class FirebaseFillform extends Polymer.Element {
      static get is() { return 'firebase-fillform'; }
      static get properties() {
        return {
          path:{
            type: String
          },
          data: {
            type: Object,
            observer:'_dataChange'
          },
          user: {
            type: Object,
            observer:'_userChange'
          },
          datauser: {
            type: Boolean,
            value: !!(this.user && this.data)
          }
        };
      }

      _dataChange() {
        this._getFields(this.data[0]);
      }
      _userChange(){
        if (this.user && !this.$.docfire.path) {
          this.$.docfire.path = this.path;
        }
      }

      _getFields(obj) {
        this._cleanError();
        for(var k in obj) {
          if (typeof obj[k]==='object') {
            if (Array.isArray(obj[k])) {
              //console.log('key: '+k + ' type: Array'); console.log(obj[k]);
              var f = this._createCombo(k, obj[k]);
              this.$.formfieldlayer.appendChild(f);
            } else {
              //console.log('key: '+k + ' type: ' + typeof obj[k]); console.log(obj[k]);
              this._getFields(obj[k]);
            }
          }

          if (typeof obj[k]==='string' || typeof obj[k]==='number') {
            var f = this._createField(k);
            this.$.formfieldlayer.appendChild(f);
          }
        }
      }

      _createFormGroup(){
        var c = document.createElement('div');
        c.className='formGroup';
        return c;
      }

      _createField(labelId, className) {
        var c = this._createFormGroup();
        if (!this.$['#'+labelId]) {
          var d = document.createElement('paper-input');
          d.label = labelId;
          d.id = labelId;
          if (className) { d.className = className; }
          c.appendChild(d);
        }
        return c;
      }
      _createCombo(labelId, arr){
        var c = this._createFormGroup();
        if (!this.$['#'+labelId]) {
          var d = document.createElement('paper-input');
          d.label = labelId;
          d.id = labelId;
          d.className = 'inlineblock';
          c.appendChild(d);
        }
        var e = document.createElement('button');
        e.id = labelId + '_btn';
        e.innerHTML='+';
        c.appendChild(d);
        c.appendChild(e);
        return c;
      }
      _showError(msg){
        this.$.formfieldlayer.innerHTML = '';
        var arrMsg = {
          nopath: 'Path <span class="path">' + this.path + '</span> doesn\'t exists',
          none: ''
        }
        var d = (!this.root.querySelector('.error_msg'))?document.createElement('div'):this.root.querySelector('.error_msg');
        d.className='error_msg';
        d.innerHTML = arrMsg[msg];
        if (!this.root.querySelector('.error_msg')) {
          this.$.formfieldlayer.appendChild(d);
        }
      }
      _cleanError(){
        var errmsg = this.root.querySelector('.error_msg');
        if (errmsg) { errmsg.remove(); }
      }

      login() {
        return this.$.auth.signInWithPopup().then(this.signin.bind(this));
      }

      logout() {
        return this.$.auth.signOut().then(this.signout.bind(this));
      }

      signin() {
        this.$.docfire.path = this.path;
        //console.log('logged');
        //console.log(this.data, this.path);
      }

      signout(){
        this.$.docfire.path = null;
        this._showError('none');
        //console.log('log out');
      }      

    }

    window.customElements.define(FirebaseFillform.is, FirebaseFillform);
  </script>
</dom-module>
